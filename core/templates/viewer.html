{# templates/viewer.html #}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Visor AR – {{ experience.name }}</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar-nft.min.js"></script>
  <style> body{margin:0;overflow:hidden;} .arjs-loader{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;z-index:10;} </style>
</head>
<body>
  <div class="arjs-loader"><div>Loading AR…</div></div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="logarithmicDepthBuffer:true"
    arjs="sourceType:webcam; debugUIEnabled:false; trackingMethod:best;"
  >

    {# assets NFT (si los hay) #}
    <a-assets>
      {% if marker_type == 'nft' %}
        {% for t in experience.targets.all %}
          {% with p=t.image.name|slice:":-4" %}
            <a-asset-item src="/media/targets/{{ p }}.fset"></a-asset-item>
            <a-asset-item src="/media/targets/{{ p }}.fset3"></a-asset-item>
            <a-asset-item src="/media/targets/{{ p }}.iset"></a-asset-item>
          {% endwith %}
        {% endfor %}
      {% endif %}
    </a-assets>

    {% for t in experience.targets.all %}
      {% with p=t.image.name|slice:":-4" %}
        {% if marker_type == 'pattern' %}
          <a-marker
            type="pattern"
            url="/media/targets/{{ p }}.patt"
            emitevents="true"
          >
        {% else %}
          <a-nft
            url="/media/targets/{{ p }}"
            smooth="true" smoothCount="10"
            smoothTolerance="0.01" smoothThreshold="5"
            emitevents="true"
          >
        {% endif %}

        {# todos los assets para este target #}
        {% for ea in experience.experienceasset_set.all %}
          {% if ea.target.id == t.id %}
            {% if ea.asset.type == 'model' %}
              <a-entity gltf-model="/media/{{ ea.asset.file }}"
                        position="{{ ea.transform.pos.0 }} {{ ea.transform.pos.1 }} {{ ea.transform.pos.2 }}"
                        rotation="{{ ea.transform.rot.0 }} {{ ea.transform.rot.1 }} {{ ea.transform.rot.2 }}"
                        scale="{{ ea.transform.scale.0 }} {{ ea.transform.scale.1 }} {{ ea.transform.scale.2 }}"
                        {% if ea.autoplay %}animation-mixer autoplay{% endif %}>
              </a-entity>
            {% elif ea.asset.type == 'image' %}
              <a-image src="/media/{{ ea.asset.file }}"
                       position="{{ ea.transform.pos.0 }} {{ ea.transform.pos.1 }} {{ ea.transform.pos.2 }}"
                       rotation="{{ ea.transform.rot.0 }} {{ ea.transform.rot.1 }} {{ ea.transform.rot.2 }}"
                       width="1" height="1">
              </a-image>
            {% elif ea.asset.type == 'video' %}
              <a-video src="/media/{{ ea.asset.file }}"
                       width="2" height="1"
                       position="{{ ea.transform.pos.0 }} {{ ea.transform.pos.1 }} {{ ea.transform.pos.2 }}"
                       rotation="{{ ea.transform.rot.0 }} {{ ea.transform.rot.1 }} {{ ea.transform.rot.2 }}"
                       {% if ea.loop %}loop{% endif %}>
              </a-video>
            {% elif ea.asset.type == 'audio' %}
              <a-entity sound="src: url(/media/{{ ea.asset.file }}); autoplay:false; loop:{% if ea.loop %}true{% else %}false{% endif %};"></a-entity>
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if marker_type == 'pattern' %}
          </a-marker>
        {% else %}
          </a-nft>
        {% endif %}
      {% endwith %}
    {% endfor %}

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    AFRAME.scenes[0].addEventListener('renderstart', () => {
      document.querySelector('.arjs-loader').style.display = 'none';
    });
    document.querySelectorAll(
      marker_type == 'pattern' ? 'a-marker' : 'a-nft'
    ).forEach(el => {
      el.addEventListener('markerFound', () => {
        fetch('/api/metrics/', {
          method: 'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ experience: {{ experience.id }} })
        });
      });
    });
  </script>
</body>
</html>
